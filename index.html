<!DOCTYPE html>
<html lang='en' class='notranslate' translate='no'>
  <head>
      <meta name='google' content='notranslate' />
      <meta charset='UTF-8'>
      <meta name='description' content='An Offline Text-to-Speech Browser Tool'>
      <meta name='keywords' content='OCR,Tesseract,SpeechSynthesis API,Text-to-Speech'>
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name='viewport' content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0' />
      <meta http-equiv='X-UA-Compatible' content='IE=Edge,chrome=1' />  
      <meta http-equiv='Content-Language' content='en' />
      <title>Text-To-Speech | Browser Tool</title>
      <meta name='msapplication-TileColor' content='#ffffff' />
      <meta name='theme-color' content='#ffffff' />
      <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
      <meta name='apple-mobile-web-app-capable' content='yes' />
      <meta name='mobile-web-app-capable' content='yes' />
      <meta name='HandheldFriendly' content='True' />
      <meta name='MobileOptimized' content='320' />  
      <meta http-equiv='Content-Security-Policy' content='upgrade-insecure-requests' /> 
      <link href='css/bootstrap-4.5.2.min.css' rel='stylesheet' type='text/css' />
      <link href='css/offcanvas.css' rel='stylesheet' type='text/css' />
      <link href='css/main.css' rel='stylesheet' type='text/css' />
  </head>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <body>
    <div class='container-fluid'>
        <form id='inputForm'>
          <div class="row">
            <div class='col-sm-4 col-12'>
              <div class="card rounded-0">
                <div class="card-header">üí¨ <strong>Speech Settings</strong></div>
                <div id='speechSettingsCard' class="card-body">
                  <div class='row'>
                    <div class='col-12'>
                      <small class="text-muted">List of Available Voices</small>
                      <p class='small'><select id="voices" name="voices" class="custom-select-sm rounded-0"></select></p>
                    </div>
                  </div>
                  <div class='row'>
                    <div class='col-6'>
                        <input type="range" orient="vertical" min="0.5" max="2" value="1" step="0.1" class='slider' id="rate" />
                        <span class='badge badge-light rounded-0 pl-2 pr-2 pt-1 pb-1'><small>Rate:</small> <span class="rate-value">1</span></span>
                    </div>
                    <div class='col-6 col-sm-6'>
                      <input type="range" orient="vertical" min="0" max="2" value="1" step="0.1" id="pitch" />
                      <span class='badge badge-light rounded-0 pl-2 pr-2 pt-1 pb-1'><small>Pitch:</small> <span class="pitch-value">1</span></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class='col-sm-8 col-12'>
              <div class="card rounded-0">
                <div class="card-header">üìÇ <strong>Upload File Content</strong></div> 
                <div id='uploadFileContentCard' class="card-body">
                    <div class='row'> 
                      <div class='col-12'>
                        <p class='w-100'><span class='badge badge-light rounded-0'>Option 1:</span><button id='uploadPDFBtn' type="button" class="btn btn-sm btn-outline-primary rounded-0"><small>üì§ Select Plaintext File</small><input id='uploadPDF' type='file' /></button>
                        <button type="button" class="btn btn-default btn-sm border rounded-circle ml-2 pl-2 pr-2" data-toggle="popover" data-title="üìÑ Upload Plaintext File" data-dismissible="true" data-placement="right" data-content='<p>All text content shall be directly input into the text field below.</p>'>&nbsp;‚Ñπ&nbsp;</button>‚áΩ‚ú®</p>
                      </div>
                    </div>
                    <div class='row'> 
                      <div class='col-12 text-center'>
                        <span class='badge badge-primary rounded-circle p-2'>or</span>
                      </div>
                    </div>
                    <div class='row'> 
                      <div class='col-12 mr-0'>
                        <p class='w-100'><span class='badge badge-light rounded-0'>Option 2:</span><button id='uploadImgBtn' type="button" class="btn  btn-sm btn-outline-primary rounded-0"><small>üì§ Open Image</small><input id='uploadImg' type='file' /></button><button type="button" class="btn btn-default btn-sm border rounded-circle ml-2 pl-2 pr-2" data-toggle="popover" data-title="üñº Upload Image File" data-dismissible="true" data-placement="right" data-content='<p>All text content embedded within in image shall be extracted and input into the text field below.</p>'>&nbsp;‚Ñπ&nbsp;</button>‚áΩ‚ú®</p>
                      </div>
                    </div>
                    <div class='row'>
                      <div class='col-4 mr-0 pr-0'>
                        <div id='img-preview' class='small border text-center'></div>
                      </div>
                      <div class='col-1 mr-0 pr-0 ml-0 pl-0'>‚áΩ<small class='small'>üëÄ </small></div>
                      <div class='col-7'>
                        <small><strong>üîç Text Extraction Process</strong></small>
                        <div class="progress">
                          <div id="ocrProgress" class="progress-bar progress-bar-striped progress-bar-animated"></div>
                        </div>
                        <small id='ocrProgressStatus' class='small'></small>
                      </div>
                    </div>
                </div>
              </div>
            </div>
          </div>

          <div class='row'>
            <div class='col-12'>
              <button type="submit" class="btn btn-outline-primary rounded-circle mb-2 ml-2 mt-2">‚ñ∂</button>
              <textarea id="toSpeak" class="form-control rounded-0" rows="5">Let me read this for you.</textarea>
              <small class="text-muted">(Note: All text present would be translated to speech by voice selected.)</small> 
            </div>
          </div>

        </form>
    </div>
    <script src='js/polyfill.js'></script>
    <script src='js/ie10-viewport-bug-workaround.js'></script>
    <script src='js/bootstrap-native-v4.js'></script>
    <script src='js/tesseract/tesseract.min.js'></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        var popoverTargets = document.querySelectorAll("[data-content]");

        Array.from(popoverTargets).map(
          popTarget => new BSN.Popover(popTarget, {
            placement: "right",
            animation: "show",
            delay: 100,
            dismissible: true,
            trigger: "click"
          })
        );
        var imgPreview=document.getElementById('img-preview');
        var ocrProgress=document.getElementById('ocrProgress');
        var ocrProgressStatus=document.getElementById('ocrProgressStatus');

        var uploadPDFBtn=document.getElementById('uploadPDFBtn');
        var uploadPDF=document.getElementById('uploadPDF');
        uploadPDFBtn.addEventListener('click', () => {
          uploadPDF.click();
        });

        var uploadImgBtn=document.getElementById('uploadImgBtn');
        var uploadImg=document.getElementById('uploadImg');
        uploadImgBtn.addEventListener('click', () => {
          uploadImg.click();
        });

        function readFileAsText(file) {
          return new Promise((resolve,reject) => {
              let fileredr = new FileReader();
              fileredr.onload = () => resolve(fileredr.result);
              fileredr.onerror = () => reject(fileredr);
              fileredr.readAsText(file);
          });
        }

        uploadPDF.addEventListener('change', (ev) => {
          let file = ev.currentTarget.files[0];
          if(!file) return;
          readFileAsText(file).then((txt) => {
            inputTxt.value=txt;
          });
        }, false);

        function readFileAsDataURL(file) {
          return new Promise((resolve,reject) => {
              let fileredr = new FileReader();
              fileredr.onload = () => resolve(fileredr.result);
              fileredr.onerror = () => reject(fileredr);
              fileredr.readAsDataURL(file);
          });
        }

        uploadImg.addEventListener('change', (ev) => {
            const worker = Tesseract.createWorker({
                workerPath: 'js/tesseract/worker.min.js',
                langPath: 'js/tesseract',
                corePath: 'js/tesseract/tesseract-core.wasm.js',
                logger: msg => {
                  // console.log(msg);
                  if(msg.status=='recognizing text') {
                    ocrProgress['style']['width']=`${parseInt(parseFloat(msg.progress)*100)}%`;
                    ocrProgressStatus.innerHTML=`<p class='mb-1 mt-1'>‚è≥ <strong>${parseInt(parseFloat(msg.progress)*100)}%</strong></p>`;
                  }
                }
            });
            Tesseract.setLogging(true);
            let file = ev.currentTarget.files[0];
            if(!file) return;
            
            readFileAsDataURL(file).then((b64str) => {
              imgPreview['style']['background-image']='url("'+b64str+'")';
              return new Promise((resolve,reject) => {
                const img = new Image();
                img.onload = () => resolve(img)
                img.onerror = (err) => reject(err);
                img.src = b64str;
              });
            }).then((loadedImg) => {
                (async () => {
                  await worker.load();
                  await worker.loadLanguage('eng');
                  await worker.initialize('eng');;

                  let result=await worker.recognize(loadedImg);
                  let extractedData=result.data;
                  console.log(extractedData);
                  let wordsArr=extractedData.words;
                  let combinedText='';
                  for(let w of wordsArr) {
                    combinedText+=(w.text)+' ';
                  }
                  inputTxt.value=combinedText;

                  await worker.terminate();

                  ocrProgress['style']['width']='100%';
                  ocrProgress.classList.remove('progress-bar-animated');
                  ocrProgressStatus.innerHTML=`<p class='mb-1 mt-1'>‚åõ <strong>Done.</strong></p>`;
                })();
            });
        }, false);

        var synth = window.speechSynthesis;

        var inputForm = document.querySelector('#inputForm');
        var inputTxt = document.querySelector('#toSpeak');
        var voiceSelect = document.querySelector('#voices');

        var pitch = document.querySelector('#pitch');
        var pitchValue = document.querySelector('.pitch-value');
        var rate = document.querySelector('#rate');
        var rateValue = document.querySelector('.rate-value');

        var defaultVoiceIndex = 9;
        var voices = [];

        function populateVoiceList() {
          voices = synth.getVoices().sort(function (a, b) {
              const aname = a.name.toUpperCase(), bname = b.name.toUpperCase();
              if ( aname < bname ) return -1;
              else if ( aname == bname ) return 0;
              else return +1;
          });

          var selectedIndex = voiceSelect.selectedIndex < 0 ? defaultVoiceIndex : voiceSelect.selectedIndex;
          voiceSelect.innerHTML = '';
          for(i = 0; i < voices.length ; i++) {
            var option = document.createElement('option');
            option.textContent = voices[i].name + ' (' + voices[i].lang + ')';
            
            (voices[i].default) ? (option.textContent += ' [DEFAULT]') : (option.textContent += '')

            option.setAttribute('data-lang', voices[i].lang);
            option.setAttribute('data-name', voices[i].name);
            voiceSelect.appendChild(option);
          }
          voiceSelect.selectedIndex = selectedIndex;
        }
        populateVoiceList();

        if (typeof speechSynthesis !== undefined && speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function speak() {
          if (synth.speaking) {
              console.error('speechSynthesis.speaking');
              return;
          }
          if (inputTxt.value !== '') {
            var utterThis = new SpeechSynthesisUtterance(inputTxt.value);
            utterThis.onend = ((event) => console.log('SpeechSynthesisUtterance.onend'));
            utterThis.onerror = ((event) => console.error('SpeechSynthesisUtterance.onerror'));

            utterThis.voice = voices[9];

            var selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name');
            console.log(selectedOption);
            for(i = 0; i < voices.length ; i++) {
              if(voices[i].name === selectedOption) {
                utterThis.voice = voices[i];
                break;
              }
            }
            utterThis.pitch = pitch.value;
            utterThis.rate = rate.value;
            synth.speak(utterThis);
          }
        }

        inputForm.onsubmit = function(event) {
          event.preventDefault();
          speak();
          inputTxt.blur();
        }
        voiceSelect.onchange = function(){
          speak();
        }
        pitch.onchange = function() {
          pitchValue.textContent = pitch.value;
        }
        rate.onchange = function() {
          rateValue.textContent = rate.value;
        }
      });
    </script>
  </body>
</html>